<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <headers-list-view></headers-list-view>
      </template>
    </test-fixture>

    <script type="module">
    import '../headers-list-view.js';
    import {middleOfNode} from '../../../@polymer/iron-test-helpers/mock-interactions.js';
    const HAS_NEW_MOUSE = (() => {
      let has = false;
      try {
        has = Boolean(new MouseEvent('x'));
      } catch (_) {}
      return has;
    })();
    /**
     * Fires a mouse event on a specific node, at a given set of coordinates.
     * This event bubbles and is cancellable.
     *
     * @param {string} type The type of mouse event (such as 'tap' or 'down').
     * @param {{ x: number, y: number }} xy The (x,y) coordinates the mouse event should be fired from.
     * @param {!Element} node The node to fire the event on.
     */
    function makeMouseEvent(type, xy, node) {
      const props = {
        bubbles: true,
        cancelable: true,
        clientX: xy.x,
        clientY: xy.y,
        // Make this a primary input.
        buttons: 1 // http://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/buttons
      };
      let e;
      if (HAS_NEW_MOUSE) {
        e = new MouseEvent(type, props);
      } else {
        e = document.createEvent('MouseEvent');
        e.initMouseEvent(
          type, props.bubbles, props.cancelable,
          null,
          null,
          0,
          0,
          props.clientX, props.clientY,
          false,
          false,
          false,
          false,
          0,
          null);
      }
      node.dispatchEvent(e);
    }

    suite('Rendering the list', () => {
      let element;
      let headers;
      setup(() => {
        element = fixture('basic');
        headers = 'Content-Type: application-json\n';
        headers += 'Content-Length: 256\n';
        headers += 'Content-Encoding: gzip';
      });

      test('container is the list container', (done) => {
        flush(() => {
          const result = element.container;
          assert.ok(result);
          done();
        });
      });

      test('Renders headers list', () => {
        element.headers = headers;
        const result = element.shadowRoot.querySelectorAll('.container .list-item');
        assert.equal(result.length, 3);
      });

      test('Double click triggers query-headers event', function(done) {
        element.addEventListener('query-headers', function clb(e) {
          element.removeEventListener('query-headers', clb);
          const result = e.detail;
          assert.equal(result.query, 'content-type');
          assert.equal(result.type, 'response');
          done();
        });
        element.headers = headers;
        const item = element.shadowRoot.querySelector('.container .list-item');
        const xy = middleOfNode(item);
        makeMouseEvent('dblclick', xy, item);
      });

      test('Re-renders the list', () => {
        element.headers = headers;
        let result = element.shadowRoot.querySelectorAll('.container .list-item');
        assert.equal(result.length, 3);
        element.headers = 'accept: application/json';
        result = element.shadowRoot.querySelectorAll('.container .list-item');
        assert.equal(result.length, 1);
      });
    });

    suite('Links discovery', () => {
      let element;
      suiteSetup(() => {
        element = fixture('basic');
      });

      test('Finds a link', () => {
        const header = '<link href="http://domain.com">';
        let compare = '&lt;link href="<a target="_blank" class="auto-link" ';
        compare += 'href="http://domain.com">http://domain.com</a>"&gt;';
        const result = element._autoLink(header);
        assert.equal(result, compare);
      });

      test('Ignores incoplete urls', () => {
        const header = '<link href="domain.com">';
        const compare = '&lt;link href="domain.com"&gt;';
        const result = element._autoLink(header);
        assert.equal(result, compare);
      });

      test('Parses complex location value', () => {
        const header = '<http://localhost:8080/pimexport/products?page=2>;rel="next";';
        const compare = '&lt;<a target="_blank" class="auto-link" ' +
          'href="http://localhost:8080/pimexport/products?page=2">' +
          'http://localhost:8080/pimexport/products?page=2</a>&gt;;rel="next";';
        const result = element._autoLink(header);
        assert.equal(result, compare);
      });
    });
    </script>
  </body>
</html>
