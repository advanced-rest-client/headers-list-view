<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../headers-list-view.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <headers-list-view></headers-list-view>
      </template>
    </test-fixture>

    <script>
    var HAS_NEW_MOUSE = (function() {
      var has = false;
      try {
        has = Boolean(new MouseEvent('x'));
      } catch (_) {}
      return has;
    })();
    /**
     * Fires a mouse event on a specific node, at a given set of coordinates.
     * This event bubbles and is cancellable.
     *
     * @param {string} type The type of mouse event (such as 'tap' or 'down').
     * @param {{ x: number, y: number }} xy The (x,y) coordinates the mouse event should be fired from.
     * @param {!Element} node The node to fire the event on.
     */
    function makeMouseEvent(type, xy, node) {
      var props = {
        bubbles: true,
        cancelable: true,
        clientX: xy.x,
        clientY: xy.y,
        // Make this a primary input.
        buttons: 1 // http://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/buttons
      };
      var e;
      if (HAS_NEW_MOUSE) {
        e = new MouseEvent(type, props);
      } else {
        e = document.createEvent('MouseEvent');
        e.initMouseEvent(
          type, props.bubbles, props.cancelable,
          null, /* view */
          null, /* detail */
          0,    /* screenX */
          0,    /* screenY */
          props.clientX, props.clientY,
          false, /*ctrlKey */
          false, /*altKey */
          false, /*shiftKey */
          false, /*metaKey */
          0,     /*button */
          null   /*relatedTarget*/);
      }
      node.dispatchEvent(e);
    }

    /* global suite, test, fixture, expect, MockInteractions, TestHelpers, sinon */
    suite('basic', function() {
      var element;
      var clickHandler;
      var headers;
      setup(function() {
        element = fixture('basic');
        headers = 'Content-Type: application-json\n';
        headers += 'Content-Length: 256\n';
        headers += 'Content-Encoding: gzip';
      });

      test('Should parse headers', function() {
        element.headers = headers;
        TestHelpers.forceXIfStamp(element);
        expect(element._headers).to.be.array;
        expect(element._headers).to.have.lengthOf(3);
      });

      test('Double click triggers event', function(done) {
        clickHandler = sinon.spy();
        element.addEventListener('query-headers', clickHandler);
        element.headers = headers;
        TestHelpers.forceXIfStamp(element);

        var item = Polymer.dom(element.root).querySelector('headers-list-item');
        var xy = MockInteractions.middleOfNode(item);
        makeMouseEvent('dblclick', xy, item);

        Polymer.Base.async(function() {
          expect(clickHandler.callCount).to.be.equal(1);
          done();
        }, 1);
      });
    });
    </script>

  </body>
</html>
